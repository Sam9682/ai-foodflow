<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodFlow - Audit Records</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        .header h1 { font-size: 2rem; margin-bottom: 5px; }
        .header p { opacity: 0.9; }
        .back-btn { display: inline-block; margin: 20px 0; padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; transition: background 0.3s; }
        .back-btn:hover { background: #5a6fd8; }
        .controls { background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .controls h3 { margin-bottom: 15px; color: #333; }
        .filter-group { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .filter-group label { font-weight: 500; color: #555; }
        .filter-group select, .filter-group input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; }
        .btn { padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        .btn:hover { background: #218838; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .table-container { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .table-header { background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #dee2e6; }
        .table-header h3 { color: #333; }
        .loading { text-align: center; padding: 40px; color: #666; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background: #f8f9fa; font-weight: 600; color: #495057; position: sticky; top: 0; }
        tr:hover { background: #f8f9fa; }
        .status-success { color: #28a745; font-weight: 500; }
        .status-error { color: #dc3545; font-weight: 500; }
        .status-info { color: #17a2b8; font-weight: 500; }
        .timestamp { font-family: monospace; font-size: 0.9em; color: #666; }
        .action-type { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 500; }
        .action-sync { background: #e3f2fd; color: #1976d2; }
        .action-menu { background: #f3e5f5; color: #7b1fa2; }
        .action-config { background: #fff3e0; color: #f57c00; }
        .action-chat { background: #e8f5e8; color: #388e3c; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 20px; }
        .pagination button { padding: 8px 12px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; }
        .pagination button:hover { background: #f8f9fa; }
        .pagination button.active { background: #667eea; color: white; border-color: #667eea; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üìä Audit Records</h1>
            <p>Complete audit trail of all FoodFlow operations</p>
        </div>
    </div>

    <div class="container">
        <a href="/main" class="back-btn">‚Üê Back to Dashboard</a>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalRecords">-</div>
                <div class="stat-label">Total Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="successRate">-</div>
                <div class="stat-label">Success Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayRecords">-</div>
                <div class="stat-label">Today's Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="errorCount">-</div>
                <div class="stat-label">Errors</div>
            </div>
        </div>

        <div class="controls">
            <h3>üîç Filters</h3>
            <div class="filter-group">
                <label>Action Type:</label>
                <select id="actionFilter">
                    <option value="">All Actions</option>
                    <option value="platform_sync">Platform Sync</option>
                    <option value="menu_operation">Menu Operation</option>
                    <option value="config_change">Config Change</option>
                    <option value="chat_interaction">Chat Interaction</option>
                </select>

                <label>Status:</label>
                <select id="statusFilter">
                    <option value="">All Status</option>
                    <option value="success">Success</option>
                    <option value="error">Error</option>
                    <option value="info">Info</option>
                </select>

                <label>Days:</label>
                <select id="daysFilter">
                    <option value="7">Last 7 days</option>
                    <option value="30">Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="">All time</option>
                </select>

                <button class="btn" onclick="loadAuditRecords()">Apply Filters</button>
                <button class="btn btn-secondary" onclick="exportRecords()">Export CSV</button>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h3>Audit Records</h3>
            </div>
            <div id="loading" class="loading">Loading audit records...</div>
            <div id="tableContainer" style="display: none;">
                <table id="auditTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Action Type</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>User/System</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="auditTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="pagination" id="pagination" style="display: none;">
            <button onclick="changePage(-1)">‚Üê Previous</button>
            <span id="pageInfo">Page 1 of 1</span>
            <button onclick="changePage(1)">Next ‚Üí</button>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let allRecords = [];

        window.onload = function() {
            loadAuditRecords();
        };

        async function loadAuditRecords() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('tableContainer').style.display = 'none';
            
            try {
                const actionType = document.getElementById('actionFilter').value;
                const status = document.getElementById('statusFilter').value;
                const days = document.getElementById('daysFilter').value;
                
                let url = '/audit/history?';
                if (actionType) url += `action_type=${actionType}&`;
                if (status) url += `status=${status}&`;
                if (days) url += `days=${days}&`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                allRecords = data.records || [];
                updateStats(data.stats || {});
                displayRecords();
                
            } catch (error) {
                console.error('Error loading audit records:', error);
                document.getElementById('loading').innerHTML = '‚ùå Error loading audit records';
            }
        }

        function updateStats(stats) {
            document.getElementById('totalRecords').textContent = stats.total_records || allRecords.length;
            document.getElementById('successRate').textContent = stats.success_rate ? `${stats.success_rate}%` : '-';
            document.getElementById('todayRecords').textContent = stats.today_records || '-';
            document.getElementById('errorCount').textContent = stats.error_count || '-';
        }

        function displayRecords() {
            const tbody = document.getElementById('auditTableBody');
            tbody.innerHTML = '';
            
            if (allRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #666;">No audit records found</td></tr>';
                document.getElementById('loading').style.display = 'none';
                document.getElementById('tableContainer').style.display = 'block';
                return;
            }

            const recordsPerPage = 50;
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            const pageRecords = allRecords.slice(startIndex, endIndex);
            
            totalPages = Math.ceil(allRecords.length / recordsPerPage);

            pageRecords.forEach(record => {
                const row = document.createElement('tr');
                
                const timestamp = new Date(record.timestamp).toLocaleString();
                const actionTypeClass = getActionTypeClass(record.action_type);
                const statusClass = getStatusClass(record.status);
                
                row.innerHTML = `
                    <td class="timestamp">${timestamp}</td>
                    <td><span class="action-type ${actionTypeClass}">${record.action_type}</span></td>
                    <td>${record.description || '-'}</td>
                    <td class="${statusClass}">${record.status}</td>
                    <td>${record.user_id || 'System'}</td>
                    <td>${record.details ? JSON.stringify(record.details).substring(0, 100) + '...' : '-'}</td>
                `;
                
                tbody.appendChild(row);
            });

            document.getElementById('loading').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';
            
            updatePagination();
        }

        function getActionTypeClass(actionType) {
            const classMap = {
                'platform_sync': 'action-sync',
                'menu_operation': 'action-menu',
                'config_change': 'action-config',
                'chat_interaction': 'action-chat'
            };
            return classMap[actionType] || 'action-sync';
        }

        function getStatusClass(status) {
            const classMap = {
                'success': 'status-success',
                'error': 'status-error',
                'info': 'status-info'
            };
            return classMap[status] || 'status-info';
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            
            if (totalPages > 1) {
                pagination.style.display = 'flex';
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            } else {
                pagination.style.display = 'none';
            }
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayRecords();
            }
        }

        async function exportRecords() {
            try {
                const actionType = document.getElementById('actionFilter').value;
                const status = document.getElementById('statusFilter').value;
                const days = document.getElementById('daysFilter').value;
                
                let url = '/audit/export?';
                if (actionType) url += `action_type=${actionType}&`;
                if (status) url += `status=${status}&`;
                if (days) url += `days=${days}&`;
                
                const response = await fetch(url);
                const blob = await response.blob();
                
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `audit_records_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
                
            } catch (error) {
                alert('‚ùå Error exporting records: ' + error.message);
            }
        }
    </script>
</body>
</html>