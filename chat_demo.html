<!DOCTYPE html>
<html>
<head>
    <title>FoodFlow AI Chat</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .chat-container { max-width: 800px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chat-header { background: #2196F3; color: white; padding: 20px; text-align: center; }
        .chat-messages { height: 500px; overflow-y: auto; padding: 20px; }
        .message { margin: 15px 0; padding: 15px; border-radius: 10px; max-width: 80%; }
        .user-message { background: #e3f2fd; margin-left: auto; text-align: right; }
        .bot-message { background: #f1f8e9; margin-right: auto; }
        .input-area { padding: 20px; border-top: 1px solid #eee; background: #fafafa; }
        .input-group { display: flex; gap: 10px; align-items: center; }
        .input-group input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        .input-group button { padding: 12px 20px; background: #2196F3; color: white; border: none; border-radius: 25px; cursor: pointer; }
        .input-group button:hover { background: #1976D2; }
        .file-input { margin: 10px 0; }
        .file-input input[type="file"] { display: none; }
        .file-button { padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 12px; }
        .suggestions { display: flex; gap: 10px; flex-wrap: wrap; margin: 15px 0; }
        .suggestion { padding: 8px 15px; background: #e0e0e0; border-radius: 20px; cursor: pointer; font-size: 13px; transition: background 0.2s; }
        .suggestion:hover { background: #d0d0d0; }
        .status { padding: 10px; background: #fff3cd; border-radius: 5px; margin: 10px 0; font-size: 14px; }
        .actions { margin: 10px 0; }
        .action-btn { padding: 8px 15px; background: #FF9800; color: white; border: none; border-radius: 20px; cursor: pointer; margin: 5px; font-size: 12px; }
        .menu-item { background: #f9f9f9; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 3px solid #2196F3; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h2>ü§ñ FoodFlow AI Assistant</h2>
            <p>Chat with AI ‚Ä¢ Upload menu images ‚Ä¢ Sync to delivery platforms</p>
        </div>
        
        <div class="chat-messages" id="messages"></div>
        
        <div class="input-area">
            <div class="file-input">
                <input type="file" id="imageFile" accept="image/*">
                <button class="file-button" onclick="document.getElementById('imageFile').click()">üìé Attach Image</button>
                <span id="fileName" style="margin-left: 10px; font-size: 12px; color: #666;"></span>
            </div>
            
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="Ask me anything about your menu..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()">Send</button>
            </div>
            
            <div class="suggestions" id="suggestions"></div>
        </div>
    </div>

    <script>
        const restaurantId = 1;
        const ws = new WebSocket(`ws://localhost:8000/chat/ws/${restaurantId}`);
        let attachedFile = null;

        ws.onopen = function() {
            console.log('Connected to FoodFlow AI');
        };

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            handleBotResponse(data);
        };

        ws.onclose = function() {
            addMessage('‚ùå Connection lost. Please refresh the page.', false, 'error');
        };

        function addMessage(content, isUser = false, type = 'normal') {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            if (type === 'error') {
                messageDiv.style.background = '#ffebee';
                messageDiv.style.color = '#c62828';
            }
            
            messageDiv.innerHTML = content;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function handleBotResponse(data) {
            if (data.type === 'welcome') {
                addMessage(`<strong>ü§ñ Assistant:</strong><br>${data.message}`);
                updateSuggestions(data.suggestions);
            } else if (data.user_message) {
                addMessage(`<strong>You:</strong> ${data.user_message}`, true);
                
                let botResponse = `<strong>ü§ñ Assistant:</strong><br>${data.response}`;
                
                if (data.type === 'menu_analyzed' && data.menu_items) {
                    botResponse += '<br><br><strong>Found Menu Items:</strong>';
                    data.menu_items.forEach(item => {
                        botResponse += `<div class="menu-item">
                            <strong>${item.name}</strong> - ‚Ç¨${item.price || 'N/A'}<br>
                            <small>${item.description || ''}</small>
                        </div>`;
                    });
                    
                    if (data.actions) {
                        botResponse += '<div class="actions">';
                        data.actions.forEach(action => {
                            botResponse += `<button class="action-btn" onclick="handleAction('${action.action}')">${action.text}</button>`;
                        });
                        botResponse += '</div>';
                    }
                }
                
                if (data.type === 'sync_completed') {
                    botResponse += '<br><br><strong>Sync Results:</strong><ul>';
                    Object.entries(data.results).forEach(([platform, result]) => {
                        const status = result.success ? '‚úÖ' : '‚ùå';
                        botResponse += `<li>${status} ${platform}: ${result.success ? 'Success' : result.error}</li>`;
                    });
                    botResponse += '</ul>';
                }
                
                addMessage(botResponse);
                
                if (data.suggestions) {
                    updateSuggestions(data.suggestions);
                }
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message && !attachedFile) return;
            
            if (attachedFile) {
                sendMessageWithImage(message || "Please analyze this menu image");
            } else {
                ws.send(JSON.stringify({message: message}));
            }
            
            input.value = '';
            clearAttachedFile();
        }

        async function sendMessageWithImage(message) {
            const formData = new FormData();
            formData.append('message', message);
            formData.append('restaurant_id', restaurantId);
            formData.append('file', attachedFile);

            try {
                const response = await fetch('/chat/message-with-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                handleBotResponse({user_message: message, ...result});
            } catch (error) {
                addMessage('‚ùå Failed to send message with image', false, 'error');
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function updateSuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '';
            suggestions.forEach(suggestion => {
                const span = document.createElement('span');
                span.className = 'suggestion';
                span.textContent = suggestion;
                span.onclick = () => {
                    document.getElementById('messageInput').value = suggestion;
                    sendMessage();
                };
                suggestionsDiv.appendChild(span);
            });
        }

        function handleAction(action) {
            if (action === 'add_items') {
                ws.send(JSON.stringify({message: "Add these items to my menu"}));
            } else if (action === 'sync_platforms') {
                ws.send(JSON.stringify({message: "Sync to Uber Eats and Deliveroo"}));
            }
        }

        function clearAttachedFile() {
            attachedFile = null;
            document.getElementById('imageFile').value = '';
            document.getElementById('fileName').textContent = '';
        }

        // File upload handling
        document.getElementById('imageFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                attachedFile = file;
                document.getElementById('fileName').textContent = `üìé ${file.name}`;
            }
        });
    </script>
</body>
</html>